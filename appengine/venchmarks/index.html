<!DOCTYPE html>

<html>
	<head>
		<title></title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<link rel="stylesheet" type="text/css" href="/css/venchmarks.css">
		<style type="text/css" media="all">

    </style>
    <script type="text/javascript"
      src="http://ajax.googleapis.com/ajax/libs/jquery/1.3/jquery.min.js"></script>
    <script type="text/javascript" src="http://eschew.org/static/js/flot-latest/jquery.flot.js"></script>
    <!--[if IE]><script language="javascript" type="text/javascript" src="http://eschew.org/static/js/flot-latest/excanvas.pack.js"></script><![endif]--> 

    <script type="text/javascript">
      var db = {{ db }};
      
      function fractionalDate(year,month,day) {
        if(typeof(month) == 'undefined') {
          var s = year.toString();
          var bits = s.match(/(\d{4})(\d\d)(\d\d)/);
          year  = parseInt(bits[1]);
          month = parseInt(bits[2]);
          day   = parseInt(bits[3]);
        }
        var ms_passed = new Date(1970, month, day) - new Date(1970, 1, 1);
        var days_passed = ms_passed/1000/60/60/24;
        var t = days_passed/365;
        return year + t;
      }
      var fd = fractionalDate;
      
      
    </script>
  </head>
	<body>
	<div id="nav-links">
<a href="/register-machine">Register Machine</a>

{% if user %}
  <span id="logged-in-as">Logged in as <a href="/users/view/{{ user.user_id }}">{{ user }}</a></span>
  <a href="{{ logout_url }}">Log Out</a>
{% else %}
  <a href="{{ login_url }}">Log In</a>
{% endif %}

  </div>
<table style="border: 1px solid black;" width="100%">
	<tr>
		<td>
			<center>
	<table border="2px">
		<tr id="mishmash-row">
			<td id="machines-td">
				<h3>Machines</h3>
				<div id="machines-cell"></div>
			</td>
			
			<td id="languages-td">
				<h3>Languages</h3>
				<div id="languages-cell"></div>
			</td>
			
			<td id="compilers-td">
				<h3>Compilers</h3>
				<div id="compilers-cell"></div>
			</td>
			
			<td id="benchmarks-td">
				<h3>Benchmarks</h3>
				<div id="benchmarks-cell"></div>
			</td>
			
			<td id="input-td">
				<h3>Independent Variable</h3>
				<div id="input-cell"></div>
			</td>
			<td id="output-td">
				<h3>Dependent Variable</h3>
				<div id="output-cell"></div>
			</td>
		</tr>
	</table>
			</center>
			<hr />
		</td>
	</tr>
	<tr>	
		<td width="80%">
		<center>
		  <span id="dependent-axis-label">bogomips</span>
			<div style="background-color: #ccc; width:800px; height:600px;" id="graph"></div>
			<span id="independent-axis-label">n</span>
		</center>
		</td>
	</tr>
</table>
<div id="log"></div>
<script type="text/javascript">
  function zoomed_results_label(result) {
    return result.benchmark_name + '.' + result.date;
  }
  
  function identity(a) { return a; }
  
  function min_of(a, f) {
    if (!f) return min_of(a, identity);
    
    var m = parseFloat(f(a[0]));
    for (var v in a) { m = Math.min(m, parseFloat(f(a[v]))); }
    return m;
  }
  
  function max_of(a, f) {
    if (!f) return max_of(a, identity);
    
    var m = parseFloat(f(a[0]));
    for (var v in a) { m = Math.max(m, parseFloat(f(a[v]))); }
    return m;
  }
 
  function log(str) {
    $('#log').append(str);
    $('#log').append('<br>');
  }
  
  function zip(a, b) {
    var m = Math.min(a.length, b.length);
    var rv = new Array(m);
    for (var i = 0; i < m; ++i) {
      rv[i] = [a[i], b[i]];
    }
    return rv;
  }
  
  function result_to_flot_data(result) {
    var result_keys = JSON.parse(result.in_keys);
    var result_values = JSON.parse(result.out_values);
    return {
      label: zoomed_results_label(result),
      data: zip(result_keys, result_values),
      max_key: max_of(result_keys),
      max_value: max_of(result_values),
    };
  }
  
  function strip_to_alpha_dash(str) {
    // TODO
  }
  
  function glob_to_regex(str) {
    // replace un-escaped metachars with escaped versions
    return str.replace(/([^\\])([\.()|+^$@%])/g, "$1\\$2")
    // replace glob star with (non-greedy) kleene star over all characters
              .replace("*", ".*?");
  }
  
  function globby_regexp(str) {
    if (!str) return new RegExp();
    if (str[0] == "~") {
      var newstr = str.slice(1);
      log(newstr);
      return new RegExp(newstr); // remove first char and use directly
    }
    return new RegExp(glob_to_regex(str));
  }
  
  $(function () {
    var result = db.results[0];
    var all_results = new Array(db.results.length);
    for (var i = 0; i < db.results.length; ++i) {
      all_results[i] = result_to_flot_data(db.results[i]);
    }
    
    var max_key = max_of(all_results, function(v) { return v.max_key; });
    var max_value = max_of(all_results, function(v) { return v.max_value; });
    
    $.plot($("#graph"), all_results, {
      lines: { show: true },
      points: { show: true },
      xaxis: { min: 0, max: max_key, tickDecimals: 0 },
      yaxis: { min: 0, max: max_value },
      grid: { backgroundColor: "#fffaff" },
      legend: { position: "nw" }
    });
    
    $("#independent-axis-label").text(db.results[0].in_name);
    $("#dependent-axis-label").text(db.results[0].out_name);
    
    log('done');
  });
  
  function filter_header(e) {
    var filter_re = globby_regexp(e.target.value);
    var header = e.data;
    var sel = $("#"+header+"-select");
    sel.empty();
    for (var i in db[header]) {
      var m = db[header][i];
      if (filter_re.test(m.name)) {
        sel.append(
          '<option value="'+m.name+'">'+m.name+'</option>'
          );
      }
    }
  }
  
  $(function() {
      var headers = ['machines', 'compilers', 'benchmarks'];
      for (var i = 0, hd_name; hd_name = headers[i]; ++i) {
          var header = $("#?-cell".replace('?', hd_name));
          header.html(
            'Filter: <input id="?-filter"type=text size=10 value="*"><br>'+
            'Active: <select id="?-select"></select>'.replace('?', hd_name));
          header.bind("change", hd_name, filter_header);
          // call once to construct initial list
          filter_header({data: hd_name, target: {value: '*'}});
      }
  });
  
</script>
	</body>
</html>

